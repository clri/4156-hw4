<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Quickbucks Maven Webapp</a> &gt; <a href="index.source.html" class="el_package">quickbucks</a> &gt; <span class="el_source">MainController.java</span></div><h1>MainController.java</h1><pre class="source lang-java linenums">package quickbucks;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.RequestMethod;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.hibernate.exception.ConstraintViolationException;
import org.springframework.ui.ModelMap;
import org.springframework.mail.MailException;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import java.util.UUID;
import java.lang.NullPointerException;

import quickbucks.User;
import quickbucks.UserRepository;
import quickbucks.MvcConfig;
import quickbucks.ReviewRepository;
import quickbucks.Review;
import java.lang.Integer;
import java.util.List;
import java.util.ArrayList;

@Controller
<span class="fc" id="L37">public class MainController {</span>

	private boolean validateInputStrings(int in, String s)
	{
<span class="fc bfc" id="L41" title="All 4 branches covered.">		if (s.length() &gt; 255 &amp;&amp; in != 6)</span>
<span class="fc" id="L42">			return false;</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">		if (!(sanitizeString(s).equals(s)))</span>
<span class="nc" id="L44">			return false;</span>
<span class="fc" id="L45">		boolean ans = true;</span>
		/*in = 1: email; in = 2: password, 3: name, 4: location
		 *5: non-empty*/
<span class="fc bfc" id="L48" title="All 6 branches covered.">		switch(in) {</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">			case 1: ans = (!s.equals(&quot;&quot;) &amp;&amp; (</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">				s.matches(&quot;[a-zA-z0-9\\.\\-]+@.*columbia.edu&quot;)</span>
				||
<span class="fc bfc" id="L52" title="All 2 branches covered.">				s.matches(&quot;[a-zA-z0-9\\.\\-]+@.*barnard.edu&quot;)));</span>
<span class="fc" id="L53">				break;</span>
<span class="fc bfc" id="L54" title="All 4 branches covered.">			case 2: ans = (!s.equals(&quot;&quot;) &amp;&amp; s.length() &gt;= 4);</span>
<span class="fc" id="L55">				break;</span>
<span class="fc" id="L56">			case 3: ans = (s.matches(&quot;[a-zA-z\\s\\-]+&quot;));</span>
<span class="fc" id="L57">				break;</span>
<span class="fc bfc" id="L58" title="All 4 branches covered.">			case 4: ans = (s.equals(&quot;ON&quot;) || s.equals(&quot;OFF&quot;));</span>
<span class="fc" id="L59">				break;</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">			case 5: ans = (!s.equals(&quot;&quot;));</span>
<span class="fc" id="L61">				break;</span>
<span class="fc" id="L62">			default: ans = true;</span>
		}
<span class="fc" id="L64">		return ans;</span>
	}

	/* sanitizeString(): remove semicolons and dashes from the given
	 * string */
	public String sanitizeString(String input)
	{
<span class="fc" id="L71">		String ans = input.replaceAll(&quot;;&quot;,&quot;&quot;);</span>
<span class="fc" id="L72">		ans = ans.replaceAll(&quot;--&quot;,&quot;&quot;);</span>
<span class="fc" id="L73">		return ans;</span>
	}

	/* setRepositories(): for testing
	 */
	public void setReposotories(UserRepository u, JobRepository j,
		RequestRepository r, ReviewRepository re,
		ResetTokenRepository rt)
	{
<span class="fc" id="L82">			userRepository = u;</span>
<span class="fc" id="L83">			jobRepository = j;</span>
<span class="fc" id="L84">			requestRepository = r;</span>
<span class="fc" id="L85">			reviewRepository = re;</span>
<span class="fc" id="L86">			resetTokenRepository = rt;</span>
<span class="fc" id="L87">	}</span>


	@Autowired
	private UserRepository userRepository;

	@GetMapping(path=&quot;/demo/adduser&quot;)
	public String addNewUser (@RequestParam String firstName
			, @RequestParam String lastName
			, @RequestParam String email
			, @RequestParam String password
			, @RequestParam String degree
			, @RequestParam String location
			, @RequestParam String school)
	{
<span class="fc bfc" id="L102" title="All 2 branches covered.">		if (!(validateInputStrings(3,firstName) &amp;&amp;</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">			validateInputStrings(3,lastName) &amp;&amp;</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">			validateInputStrings(1,email) &amp;&amp;</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">			validateInputStrings(2,password) &amp;&amp;</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">			validateInputStrings(0,degree) &amp;&amp;</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">			validateInputStrings(4,location) &amp;&amp;</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">			validateInputStrings(0,school)))</span>
<span class="fc" id="L109">			return &quot;redirect:/index3.html&quot;;</span>

<span class="fc" id="L111">		firstName = sanitizeString(firstName);</span>
<span class="fc" id="L112">		lastName = sanitizeString(lastName);</span>
<span class="fc" id="L113">		email = sanitizeString(email);</span>
<span class="fc" id="L114">		password = sanitizeString(password);</span>
<span class="fc" id="L115">		degree = sanitizeString(degree);</span>
<span class="fc" id="L116">		location = sanitizeString(location);</span>
<span class="fc" id="L117">		school = sanitizeString(school);</span>

		try {
<span class="fc" id="L120">			int uid = userRepository.findIDByEmail(email);</span>
<span class="fc" id="L121">		} catch (Exception e) {</span>
<span class="fc" id="L122">			User n = new User();</span>
<span class="fc" id="L123">			n.setUserFirstName(firstName);</span>
<span class="fc" id="L124">			n.setUserLastName(lastName);</span>
<span class="fc" id="L125">			n.setUserEmail(email);</span>
<span class="fc" id="L126">			n.setUserDegree(degree);</span>
<span class="fc" id="L127">			n.setUserLocation(location);</span>
<span class="fc" id="L128">			n.setUserSchool(school);</span>
<span class="fc" id="L129">			BCryptPasswordEncoder passwordEncoder = new</span>
				BCryptPasswordEncoder();
<span class="fc" id="L131">			String hashedPassword =</span>
<span class="fc" id="L132">				passwordEncoder.encode(password);</span>
<span class="fc" id="L133">			n.setUserPassword(hashedPassword);</span>
			try {
<span class="fc" id="L135">				userRepository.save(n);</span>
<span class="nc" id="L136">			} catch (Exception ee) {</span>
<span class="nc" id="L137">				return genericError();</span>
<span class="fc" id="L138">			}</span>
<span class="fc" id="L139">			return &quot;redirect:/index2.html&quot;;</span>
<span class="fc" id="L140">		}</span>

<span class="fc" id="L142">		return &quot;redirect:/index3.html&quot;;</span>
	}

	@Autowired
	private JobRepository jobRepository;

	@GetMapping(path=&quot;/demo/postJob&quot;)
	public String addNewJob (ModelMap model, @RequestParam String jobtitle
			, @RequestParam String jobdesc, String category)
	{
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (!validateInputStrings(5, jobtitle) ||</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">			!validateInputStrings(6, jobdesc) ||</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">			!validateInputStrings(5, category))</span>
<span class="fc" id="L155">			return genericError();</span>

<span class="fc" id="L157">		jobtitle = sanitizeString(jobtitle);</span>
<span class="fc" id="L158">		jobdesc = sanitizeString(jobdesc);</span>
<span class="fc bfc" id="L159" title="All 4 branches covered.">		if (jobdesc.length() &gt; 1500 || jobdesc.equals(&quot;&quot;))</span>
<span class="fc" id="L160">			return genericError();</span>
<span class="fc" id="L161">		category = sanitizeString(category);</span>

<span class="fc" id="L163">		int uid = -1;</span>
<span class="fc" id="L164">		Job j = new Job();</span>
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L166">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
		try {
<span class="fc" id="L168">			uid = userRepository.findIDByEmail(user.getUsername());</span>
<span class="nc" id="L169">		} catch(Exception ee) {</span>
<span class="nc" id="L170">			return genericError();</span>
<span class="fc" id="L171">		}</span>

<span class="fc" id="L173">		j.setUser(uid);</span>
<span class="fc" id="L174">		j.setJobTitle(jobtitle);</span>
<span class="fc" id="L175">		j.setJobDescription(jobdesc);</span>
<span class="fc" id="L176">		j.setCategory(category);</span>
/*		try{
			double payrate = Double.parseDouble(pay);
			j.setPay(payrate);
		}
		catch(NumberFormatException e){}
		*/

		//j.setStatus(0); //jobs are created as 'open'

		//set tags, date
		try {
<span class="fc" id="L188">			jobRepository.save(j);</span>
<span class="nc" id="L189">		} catch(Exception ee) {</span>
<span class="nc" id="L190">			return genericError();</span>
<span class="fc" id="L191">		}</span>
<span class="fc" id="L192">		model.addAttribute(&quot;user&quot;, uid);</span>
<span class="fc" id="L193">		model.addAttribute(&quot;userEmail&quot;, user.getUsername());</span>
<span class="fc" id="L194">		model.addAttribute(&quot;jobID&quot;, j.getId());</span>
<span class="fc" id="L195">		model.addAttribute(&quot;title&quot;, j.getJobtitle());</span>
<span class="fc" id="L196">		model.addAttribute(&quot;desc&quot;, j. getJobdesc());</span>
<span class="fc" id="L197">		model.addAttribute(&quot;tags&quot;, j.getCategory());</span>

<span class="fc" id="L199">		return &quot;viewJob&quot;;</span>
	}

	@GetMapping(path=&quot;/demo/search&quot;)
	public String searchJobs(ModelMap model, @RequestParam String keywords,
	@RequestParam String category, @RequestParam String pageNum)
	{
<span class="fc" id="L206">		keywords = sanitizeString(keywords);</span>
<span class="fc" id="L207">		category = sanitizeString(category);</span>
<span class="fc" id="L208">		pageNum = sanitizeString(pageNum);</span>

<span class="fc" id="L210">		String keynull = &quot;%&quot;+keywords+&quot;%&quot;;</span>
<span class="fc" id="L211">		String catnull = &quot;%&quot;+category+&quot;%&quot;;</span>
<span class="fc" id="L212">		int limit = 10;</span>

<span class="fc" id="L214">		Integer count = 1;</span>
		try {
<span class="fc" id="L216">			count = jobRepository.searchCount(keywords, category);</span>
<span class="nc" id="L217">		} catch (Exception e) {</span>
<span class="nc" id="L218">			count = 1;</span>
<span class="fc" id="L219">		}</span>
<span class="fc" id="L220">		int maxPage = count/limit;</span>
<span class="fc" id="L221">		maxPage++; /*limit 1, x; is ok*/</span>

<span class="fc" id="L223">		int page = 1;</span>
		try{
<span class="fc" id="L225">			page = Integer.parseInt(pageNum);</span>
<span class="fc" id="L226">		}catch(NumberFormatException e){</span>
<span class="fc" id="L227">			System.out.println(&quot;parse error&quot;);</span>
<span class="fc" id="L228">			return genericError();</span>
<span class="fc" id="L229">		}</span>

<span class="fc bfc" id="L231" title="All 2 branches covered.">		if (page &lt; 1)</span>
<span class="fc" id="L232">			page = 1;</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">		if(page &gt; maxPage)</span>
<span class="fc" id="L234">			page = maxPage;</span>

<span class="fc" id="L236">		int start = (page-1)*limit;</span>

<span class="fc" id="L238">		List results = new ArrayList();</span>
<span class="fc" id="L239">		boolean isAll = false;</span>
<span class="fc bfc" id="L240" title="All 4 branches covered.">		if (keywords.equals(&quot;&quot;) &amp;&amp; category.equals(&quot;&quot;)){</span>
<span class="fc" id="L241">			results = jobRepository.findAllJobs(start, limit);</span>
<span class="fc" id="L242">			isAll = true;</span>
		}
<span class="fc bfc" id="L244" title="All 2 branches covered.">		else if (keywords.equals(&quot;&quot;))</span>
<span class="fc" id="L245">			keynull = &quot;%&quot;;</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">		else if (category.equals(&quot;&quot;))</span>
<span class="fc" id="L247">			catnull = &quot;%&quot;;</span>

<span class="fc bfc" id="L249" title="All 2 branches covered.">		if(!isAll) {</span>
<span class="fc" id="L250">			results = jobRepository.findJobByBoth(keynull, catnull, start, limit);</span>
		}

<span class="fc" id="L253">		int prev = page-1;</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">		if(prev &lt;=0)</span>
<span class="fc" id="L255">			prev = 1;</span>
<span class="fc" id="L256">		int next = page+1;</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">		if(next &gt; maxPage)</span>
<span class="fc" id="L258">			next = maxPage;</span>

<span class="fc" id="L260">		model.addAttribute(&quot;test&quot;, &quot;hello&quot;);</span>
<span class="fc" id="L261">		model.addAttribute(&quot;results&quot;, results);</span>
<span class="fc" id="L262">		model.addAttribute(&quot;currPage&quot;, page + &quot;&quot;);</span>
<span class="fc" id="L263">		model.addAttribute(&quot;key&quot;,keywords);</span>
<span class="fc" id="L264">		model.addAttribute(&quot;cat&quot;,category);</span>

<span class="fc" id="L266">		model.addAttribute(&quot;prev&quot;,&quot;&quot;+prev);</span>
<span class="fc" id="L267">		model.addAttribute(&quot;next&quot;,&quot;&quot;+next);</span>
<span class="fc" id="L268">		model.addAttribute(&quot;max&quot;,&quot;&quot;+maxPage);</span>
<span class="fc" id="L269">		return &quot;searchResults&quot;;</span>
	}

	@RequestMapping(value = &quot;/employeeReview&quot;, method = RequestMethod.GET)
	public String lookupJobByID()
	{
		//org.springframework.security.core.userdetails.User user
			//= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();



		//and then from there getUsername() should get you the email



<span class="nc" id="L284">		return &quot;jobByID&quot;;</span>

   	}

   	@RequestMapping(value = &quot;/finalPage&quot;, method = RequestMethod.GET)
   	public String viewJob(ModelMap model, @RequestParam String id)
	{
<span class="fc" id="L291">		id = sanitizeString(id);</span>

<span class="fc" id="L293">	 	Job j = jobRepository.findJobByID(id);</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">	 	if (j == null) {</span>
<span class="fc" id="L295">			model.addAttribute(&quot;jobID&quot;, id);</span>
<span class="fc" id="L296">			return &quot;viewJobError&quot;;</span>
	 	}
	 	else{
<span class="fc" id="L299">			String email = userRepository.findEmailById(j.getUser());</span>
<span class="fc" id="L300">			model.addAttribute(&quot;user&quot;, j.getUser());</span>
<span class="fc" id="L301">			model.addAttribute(&quot;userEmail&quot;, email);</span>
<span class="fc" id="L302">			model.addAttribute(&quot;jobID&quot;, j.getId());</span>
<span class="fc" id="L303">			model.addAttribute(&quot;title&quot;, j.getJobtitle());</span>
<span class="fc" id="L304">			model.addAttribute(&quot;desc&quot;, j. getJobdesc());</span>
<span class="fc" id="L305">			model.addAttribute(&quot;tags&quot;, j.getCategory());</span>
	   	}

<span class="fc" id="L308">		return &quot;viewJob&quot;;</span>
	}


	@Autowired
	private RequestRepository requestRepository;

	@GetMapping(path=&quot;/demo/request&quot;) // Map ONLY GET Requests
	public String addNewJob (@RequestParam String id)
	{
<span class="fc" id="L318">		id = sanitizeString(id);</span>

<span class="fc" id="L320">		Job j = jobRepository.findJobByID(id);</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">		if (j == null){</span>
<span class="fc" id="L322">			System.out.println(&quot;job null&quot;);</span>
<span class="fc" id="L323">			return &quot;redirect:/searchJobsRF.html&quot;;</span>
		}
<span class="fc" id="L325">		int emp = -1;</span>
		try {
<span class="fc" id="L327">			emp = requestRepository.findAcceptedEmployee(id);</span>
<span class="fc" id="L328">		} catch (Exception fae) {}</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">		if (emp != -1)</span>
<span class="fc" id="L330">			return &quot;redirect:/searchJobsRF.html&quot;; //already requested</span>

		org.springframework.security.core.userdetails.User user
<span class="fc" id="L333">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L334">		int uid = userRepository.findIDByEmail(user.getUsername());</span>

		/*FAIL CASES:
		requesting your own job. Should bounce you back to the search
		page with a message. also you cannot request something you
		have already requested.*/
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">		if (j.getUser() == uid)</span>
<span class="nc" id="L341">			return &quot;redirect:/searchJobsRF.html&quot;;</span>
		Request rr;
		try {
<span class="fc" id="L344">			rr = requestRepository.findRequestByJobAndEmployee(j.getId() + &quot;&quot;, uid);</span>
<span class="nc" id="L345">		} catch (Exception rex) {</span>
<span class="nc" id="L346">			return genericError();</span>
<span class="fc" id="L347">		}</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">		if (rr != null){</span>
<span class="fc" id="L349">			System.out.println(&quot;request already exists&quot;);</span>
<span class="fc" id="L350">			return &quot;redirect:/searchJobsRF.html&quot;;</span>
		}

<span class="fc" id="L353">		Request r = new Request();</span>
<span class="fc" id="L354">		r.setEmployee(uid);</span>
<span class="fc" id="L355">		r.setTitle(j.getJobtitle());</span>
<span class="fc" id="L356">		r.setEmployer(j.getUser());</span>
<span class="fc" id="L357">		r.setJob(j.getId());</span>
<span class="fc" id="L358">		r.setMsg(&quot;&quot;);</span>

		try {
<span class="fc" id="L361">			requestRepository.save(r);</span>
<span class="nc" id="L362">		} catch (Exception ee) {</span>
<span class="nc" id="L363">			return genericError();</span>
<span class="fc" id="L364">		}</span>
<span class="fc" id="L365">		return &quot;redirect:/requestSuccess.html&quot;;</span>
	}

	@RequestMapping(value=&quot;/logout&quot;, method = RequestMethod.GET)
	public String logoutPage (HttpServletRequest request,
		HttpServletResponse response)
	{
		Authentication auth =
<span class="nc" id="L373">			SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (auth != null) {</span>
<span class="nc" id="L375">			new SecurityContextLogoutHandler().logout(request,</span>
				response, auth);
		}
<span class="nc" id="L378">		return &quot;logoutPage&quot;;//You can redirect wherever you want, but generally it's a good practice to show login screen again.</span>
	}

	@Autowired
	private ReviewRepository reviewRepository;

	public String createReview(ModelMap model, @RequestParam String id)
	{
<span class="fc" id="L386">		id = sanitizeString(id);</span>

<span class="fc" id="L388">	 	Job j = jobRepository.findJobByID(id);</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">	 	if (j ==null) {</span>
<span class="fc" id="L390">			model.addAttribute(&quot;jobID&quot;, id);</span>
<span class="fc" id="L391">			return &quot;reviewJobError&quot;;</span>
	 	}
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L394">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L395">		int uid = userRepository.findIDByEmail(user.getUsername());</span>
		int accid;
		try {
<span class="fc" id="L398">			accid = requestRepository.findAcceptedEmployee(id);</span>
<span class="fc" id="L399">		} catch (Exception ne) {</span>
			/*no one has accepted this job; access denied*/
<span class="fc" id="L401">			return &quot;redirect:/403.html&quot;;</span>
<span class="fc" id="L402">		}</span>
<span class="fc bfc" id="L403" title="All 4 branches covered.">		if (accid != uid &amp;&amp; uid != j.getUser())</span>
<span class="fc" id="L404">			return &quot;redirect:/403.html&quot;; /* someone else accepted */</span>

<span class="fc" id="L406">		model.addAttribute(&quot;jobID&quot;, j.getId());</span>
<span class="fc" id="L407">		model.addAttribute(&quot;title&quot;, j.getJobtitle());</span>
<span class="fc" id="L408">		model.addAttribute(&quot;desc&quot;, j. getJobdesc());</span>
<span class="fc" id="L409">		model.addAttribute(&quot;tags&quot;, j.getCategory());</span>

<span class="fc" id="L411">		return &quot;createReview&quot;;</span>
	}

	@RequestMapping(value = &quot;/createAReview&quot;, method = RequestMethod.GET)
	public String doReview(ModelMap model, @RequestParam String id)
	{
<span class="fc" id="L417">		model.addAttribute(&quot;errmsg&quot;,&quot;&quot;); //clean page, no error message</span>
<span class="fc" id="L418">		return createReview(model, id);</span>
	}

	@Autowired
        public JavaMailSender emailSender;

	@GetMapping(path=&quot;/demo/review&quot;) // Map ONLY GET Requests
	public String addNewReview (ModelMap model, @RequestParam String id,
		@RequestParam String rating, @RequestParam String reviewBody)
	{
<span class="fc" id="L428">		id = sanitizeString(id);</span>
<span class="fc" id="L429">	 	rating = sanitizeString(rating);</span>
<span class="fc" id="L430">		reviewBody = sanitizeString(reviewBody);</span>
<span class="fc" id="L431">		double rat = 0.0;</span>

<span class="fc bfc" id="L433" title="All 4 branches covered.">		if (reviewBody.length() &gt; 1500 || reviewBody.length() &lt; 10) {</span>
<span class="fc" id="L434">			model.addAttribute(&quot;errmsg&quot;, &quot;review must be between 10 and 100 characters&quot;);</span>
<span class="fc" id="L435">			return createReview(model, id); //invalid input</span>
		}

		try {
<span class="fc" id="L439">			rat = Double.parseDouble(rating);</span>
<span class="fc" id="L440">		} catch (Exception eee) {</span>
<span class="fc" id="L441">			model.addAttribute(&quot;errmsg&quot;, &quot;rating must be numerical out of five&quot;);</span>
<span class="fc" id="L442">			return createReview(model, id); //invalid input</span>
<span class="fc" id="L443">		}</span>
<span class="fc bfc" id="L444" title="All 4 branches covered.">		if (rat &lt; 0.0 || rat &gt; 5.0) {</span>
<span class="fc" id="L445">			model.addAttribute(&quot;errmsg&quot;, &quot;rating must be numerical between 0 and five&quot;);</span>
<span class="fc" id="L446">			return createReview(model, id); //invalid input</span>
		}
<span class="fc" id="L448">		model.addAttribute(&quot;errmsg&quot;,&quot;&quot;);</span>

<span class="fc" id="L450">		Job j = new Job();</span>
		try {
<span class="fc" id="L452">			j = jobRepository.findJobByID(id);</span>
<span class="nc" id="L453">		} catch (Exception e) {</span>
<span class="nc" id="L454">			return genericError();</span>
<span class="fc" id="L455">		}</span>
<span class="fc" id="L456">		Review r = new Review();</span>
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L458">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L459">		int uid = userRepository.findIDByEmail(user.getUsername());</span>

		int accid;
		try {
<span class="fc" id="L463">			accid = requestRepository.findAcceptedEmployee(id);</span>
<span class="nc" id="L464">		} catch (Exception ne) {</span>
			/*no one has accepted this job; access denied*/
<span class="nc" id="L466">			return &quot;redirect:/403.html&quot;;</span>
<span class="fc" id="L467">		}</span>
<span class="pc bpc" id="L468" title="1 of 4 branches missed.">		if (accid != uid &amp;&amp; uid != j.getUser())</span>
<span class="nc" id="L469">			return &quot;redirect:/403.html&quot;; /* someone else accepted */</span>

		/*FAIL CASES:
		Review for this job has already been posted
		Cannot parse double for rating.
		reviewBody is too long
		you were not the person who was accepted for the job or employer
		*/
<span class="fc" id="L477">		r.setEmployee(accid);</span>
<span class="fc" id="L478">		r.setEmployer(j.getUser());</span>
<span class="fc" id="L479">		r.setAuthor(uid);</span>
<span class="fc" id="L480">		r.setJob(j.getId());</span>
<span class="fc" id="L481">		r.setReviewbody(reviewBody);</span>
<span class="fc" id="L482">		r.setRating(rat);</span>

		try {
<span class="fc" id="L485">			reviewRepository.save(r);</span>
<span class="nc" id="L486">		} catch(Exception ee) {</span>
<span class="nc" id="L487">			return genericError();</span>
<span class="fc" id="L488">		}</span>

		/*mark request as read*/
		Request req;
		try {
<span class="fc" id="L493">			req = requestRepository.findRequestByJobAndEmployee(id, accid);</span>
<span class="nc" id="L494">		} catch (Exception rex) {</span>
<span class="nc" id="L495">			return genericError();</span>
<span class="fc" id="L496">		}</span>
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">		if (req == null)</span>
<span class="nc" id="L498">			return genericError();</span>

<span class="fc bfc" id="L500" title="All 2 branches covered.">		if (uid == accid)</span>
<span class="fc" id="L501">			req.setEmployeeRead(true);</span>
		else
<span class="fc" id="L503">			req.setEmployerRead(true);</span>

		try {
<span class="fc" id="L506">			requestRepository.save(req);</span>
<span class="nc" id="L507">		} catch(Exception ree) {</span>
<span class="nc" id="L508">			return genericError();</span>
<span class="fc" id="L509">		}</span>

		try {
<span class="fc" id="L512">			SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="fc" id="L513">			message.setTo(userRepository.findEmailById(j.getUser()));</span>
<span class="fc" id="L514">			message.setSubject(&quot;Review posted for job &quot; +</span>
<span class="fc" id="L515">				j.getId().toString() + &quot; on Quickbucks&quot;);</span>
<span class="fc" id="L516">			message.setText(&quot;Rating: &quot; + rating + &quot;\n\n\n&quot;</span>
				+ reviewBody);
			try {
<span class="nc" id="L519">				emailSender.send(message);</span>
<span class="pc" id="L520">			} catch (NullPointerException ne) {}</span>
<span class="nc" id="L521">		} catch (MailException exception) {</span>
<span class="nc" id="L522">			exception.printStackTrace();</span>
<span class="fc" id="L523">		}</span>

<span class="fc" id="L525">		return &quot;redirect:/reviewCreated.html&quot;;</span>
	}

	@Autowired
	private ResetTokenRepository resetTokenRepository;

	@GetMapping(path=&quot;/sendForgotEmail&quot;)
	public String sendForgotEmail (@RequestParam String email)
	{
<span class="fc" id="L534">		email = sanitizeString(email);</span>

		try {
<span class="fc" id="L537">			int uid = userRepository.findIDByEmail(email);</span>
<span class="fc" id="L538">		} catch (Exception e) {</span>
			//fail case: not in the respository
<span class="fc" id="L540">			return &quot;redirect:/notregistered.html&quot;;</span>
<span class="fc" id="L541">		}</span>

<span class="fc" id="L543">		String token = UUID.randomUUID().toString();</span>
<span class="fc" id="L544">		token = sanitizeString(token);</span>
<span class="fc" id="L545">		ResetToken rt = new ResetToken();</span>
<span class="fc" id="L546">		rt.setToken(token);</span>
<span class="fc" id="L547">		rt.setUserEmail(email);</span>
		try {
<span class="fc" id="L549">			resetTokenRepository.save(rt);</span>
<span class="fc" id="L550">		} catch (Exception ee) {</span>
<span class="fc" id="L551">			return genericError();</span>
<span class="fc" id="L552">		}</span>

		try {
<span class="fc" id="L555">			SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="fc" id="L556">			message.setTo(email);</span>
<span class="fc" id="L557">			message.setSubject(&quot;Reset password code from Quickbucks&quot;);</span>
<span class="fc" id="L558">			message.setText(token);</span>
			try {
<span class="nc" id="L560">				emailSender.send(message);</span>
<span class="pc" id="L561">			} catch (NullPointerException ne) {}</span>
<span class="nc" id="L562">		} catch (MailException exception) {</span>
<span class="nc" id="L563">			exception.printStackTrace();</span>
<span class="fc" id="L564">		}</span>

<span class="fc" id="L566">		return &quot;redirect:/inputToken.html&quot;;</span>

	}

	@GetMapping(path=&quot;/checkReset&quot;)
	public String checkReset (ModelMap model, @RequestParam String email,
		@RequestParam String token)
	{
<span class="fc" id="L574">		email = sanitizeString(email);</span>
<span class="fc" id="L575">	 	token = sanitizeString(token);</span>

<span class="fc" id="L577">		ResetToken rt = resetTokenRepository.lookupRTByBoth(email, token);</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">		if (rt == null)</span>
<span class="fc" id="L579">			return genericError();</span>

<span class="fc" id="L581">		model.addAttribute(&quot;email&quot;, email);</span>
<span class="fc" id="L582">		model.addAttribute(&quot;token&quot;, token);</span>

<span class="fc" id="L584">		return &quot;doReset&quot;;</span>
	}

	@GetMapping(path=&quot;/demo/reset&quot;)
	public String doReset (@RequestParam String email, @RequestParam String
		token, @RequestParam String password)
	{
<span class="fc" id="L591">		email = sanitizeString(email);</span>
<span class="fc" id="L592">	 	token = sanitizeString(token);</span>
<span class="fc" id="L593">		password = sanitizeString(password);</span>

<span class="fc bfc" id="L595" title="All 2 branches covered.">		if (!(validateInputStrings(2,password))) {</span>
<span class="fc" id="L596">			return genericError(); //need a better error...</span>
			//probably something like doReset but with a
			//&quot;your password must be xyz&quot;
		}
<span class="fc" id="L600">		ResetToken rt = resetTokenRepository.lookupRTByBoth(email, token);</span>
<span class="fc bfc" id="L601" title="All 2 branches covered.">		if (rt == null)</span>
<span class="fc" id="L602">			return genericError();</span>

<span class="fc" id="L604">		resetTokenRepository.delete(rt);</span>

<span class="fc" id="L606">		User u = new User();</span>
		try {
<span class="fc" id="L608">			u = userRepository.findUserByEmail(email);</span>
<span class="nc" id="L609">		} catch (Exception ee) {</span>
<span class="nc" id="L610">			return genericError();</span>
<span class="fc" id="L611">		}</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">		if (u == null)</span>
<span class="nc" id="L613">			return genericError();</span>

<span class="fc" id="L615">		BCryptPasswordEncoder passwordEncoder = new</span>
			BCryptPasswordEncoder();
<span class="fc" id="L617">		String hashedPassword = passwordEncoder.encode(password);</span>
<span class="fc" id="L618">		u.setUserPassword(hashedPassword);</span>

		try {
<span class="fc" id="L621">			userRepository.save(u);</span>
<span class="nc" id="L622">		} catch(Exception eee) {</span>
<span class="nc" id="L623">			return genericError();</span>
<span class="fc" id="L624">		}</span>
<span class="fc" id="L625">		return &quot;redirect:/savedreset.html&quot;;</span>
	}

	private void sendEmailToUser(String e, String subj, String body)
		throws MailException
	{
<span class="fc" id="L631">		SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="fc" id="L632">		message.setTo(e);</span>
<span class="fc" id="L633">		message.setSubject(subj);</span>
<span class="fc" id="L634">		message.setText(body);</span>
		try {
<span class="nc" id="L636">			emailSender.send(message);</span>
<span class="pc" id="L637">		} catch (NullPointerException ne) {}</span>
<span class="fc" id="L638">	}</span>

	@GetMapping(path=&quot;/demo/contact&quot;)
	public String contactStepOne (ModelMap model, @RequestParam String id)
	{
<span class="fc" id="L643">		id = sanitizeString(id);</span>

<span class="fc" id="L645">		model.addAttribute(&quot;id&quot;,id);</span>
<span class="fc" id="L646">		return &quot;composeMessage&quot;;</span>
	}

	@GetMapping(path=&quot;/demo/sendcontact&quot;)
	public String contactPoster(@RequestParam String id,
		@RequestParam String msg)
	{
<span class="fc" id="L653">	 	id = sanitizeString(id);</span>
<span class="fc" id="L654">		msg = sanitizeString(msg);</span>

<span class="fc bfc" id="L656" title="All 4 branches covered.">		if (msg.length() &gt; 1500 || msg.length() &lt; 10) {</span>
<span class="fc" id="L657">			return genericError();</span>
		}

<span class="fc" id="L660">		Job j = new Job();</span>
		try {
<span class="fc" id="L662">			j = jobRepository.findJobByID(id);</span>
<span class="nc" id="L663">		} catch(Exception e) {</span>
<span class="nc" id="L664">			return genericError();</span>
<span class="fc" id="L665">		}</span>
<span class="fc bfc" id="L666" title="All 2 branches covered.">	 	if (j ==null)</span>
<span class="fc" id="L667">			return genericError();</span>

<span class="fc" id="L669">		String empl = &quot;&quot;;</span>
		try {
<span class="fc" id="L671">			empl = userRepository.findEmailById(j.getUser());</span>
<span class="nc" id="L672">		} catch(Exception ee) {</span>
<span class="nc" id="L673">			return genericError(); //null job user</span>
<span class="fc" id="L674">		}</span>

		org.springframework.security.core.userdetails.User user
<span class="fc" id="L677">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L678">		String username = user.getUsername();</span>
<span class="fc bfc" id="L679" title="All 2 branches covered.">		if (username.equals(empl))</span>
<span class="fc" id="L680">			return genericError(); //can't send email to self</span>

<span class="fc" id="L682">		String msgbody = &quot;Hi from Quickbucks!\n\nYou've received a new inquiry about your job &quot; +</span>
			id + &quot; from a potential employee (&quot; + username +
			&quot;). Their message:\n&quot; + msg + &quot;\n\nLove,\nQuickbucks&quot;;

		try {
<span class="fc" id="L687">			sendEmailToUser(empl,</span>
				&quot;Contact from potential employee on Quickbucks&quot;,
				msgbody);
<span class="nc" id="L690">		} catch (MailException exception) {</span>
<span class="nc" id="L691">			exception.printStackTrace();</span>
			//return genericError()?
<span class="fc" id="L693">		}</span>

<span class="fc" id="L695">		return &quot;redirect:/sent.html&quot;;</span>
	}

	@GetMapping(path=&quot;/notifications&quot;)
	public String displayNotifications(ModelMap model) {
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L701">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L702">		String username = user.getUsername();</span>
<span class="fc" id="L703">		int uid = userRepository.findIDByEmail(username);</span>

<span class="fc" id="L705">		List&lt;Request&gt; notifs = requestRepository.getNotifsByUserID(uid);</span>

<span class="fc" id="L707">		model.addAttribute(&quot;notifs&quot;, notifs);</span>
<span class="fc" id="L708">		model.addAttribute(&quot;userr&quot;, uid);</span>

<span class="fc" id="L710">		return &quot;notifs&quot;;</span>
	}

	@GetMapping(path=&quot;/read&quot;)
	public String readDecision(ModelMap model, @RequestParam Integer id)
	{
<span class="fc" id="L716">		Request r = requestRepository.findRequestByID(id);</span>
<span class="fc bfc" id="L717" title="All 2 branches covered.">		if (r == null)</span>
<span class="fc" id="L718">			return genericError();</span>
<span class="fc" id="L719">		int jid = r.getJob();</span>

<span class="fc" id="L721">		Job j = jobRepository.findJobByID(jid + &quot;&quot;);</span>
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">		if (j == null)</span>
<span class="nc" id="L723">			return genericError();</span>

		org.springframework.security.core.userdetails.User meUser
<span class="fc" id="L726">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L727">		String username = meUser.getUsername();</span>
<span class="fc" id="L728">		int uid = userRepository.findIDByEmail(username);</span>

<span class="fc bfc" id="L730" title="All 2 branches covered.">		if (r.getEmployee() != uid)</span>
<span class="fc" id="L731">			return &quot;redirect:/403.html&quot;; //unauthorized</span>
<span class="fc" id="L732">		r.setEmployeeRead(true);</span>
		try {
<span class="fc" id="L734">			requestRepository.save(r);</span>
<span class="pc" id="L735">		} catch(Exception eee) {}</span>
<span class="fc" id="L736">		return displayNotifications(model);</span>
	}

	@GetMapping(path=&quot;/decide&quot;)
	public String makeDecision(ModelMap model, @RequestParam Integer id,
		@RequestParam Integer decision)
	{
		/*error cases: decision not 1 or 2, job already decided, job
		 *not yours to decide (you are not employer), request does not
		 *exist */
<span class="fc bfc" id="L746" title="All 4 branches covered.">		if (decision != 1 &amp;&amp; decision != 2)</span>
<span class="fc" id="L747">			return genericError();</span>

<span class="fc" id="L749">		Request r = requestRepository.findRequestByID(id);</span>
<span class="fc bfc" id="L750" title="All 2 branches covered.">		if (r == null)</span>
<span class="fc" id="L751">			return genericError();</span>
<span class="fc" id="L752">		int jid = r.getJob();</span>

<span class="fc" id="L754">		Job j = new Job();</span>
		try {
<span class="fc" id="L756">			j = jobRepository.findJobByID(jid + &quot;&quot;);</span>
<span class="nc" id="L757">		} catch(Exception ee) {</span>
<span class="nc" id="L758">			return genericError();</span>
<span class="fc" id="L759">		}</span>
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">		if (j == null)</span>
<span class="nc" id="L761">			return genericError();</span>

		org.springframework.security.core.userdetails.User meUser
<span class="fc" id="L764">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L765">		String username = meUser.getUsername();</span>
<span class="fc" id="L766">		int uid = userRepository.findIDByEmail(username);</span>

<span class="fc bfc" id="L768" title="All 2 branches covered.">		if (r.getEmployer() != uid)</span>
<span class="fc" id="L769">			return &quot;redirect:/403.html&quot;; /*unauthorized*/</span>
<span class="fc bfc" id="L770" title="All 2 branches covered.">		if (r.getDecision() != 0)</span>
<span class="fc" id="L771">			return genericError();</span>

<span class="fc" id="L773">		r.decide(decision);</span>
		try {
<span class="fc" id="L775">			requestRepository.save(r);</span>
<span class="nc" id="L776">		} catch (Exception eee) {</span>
<span class="nc" id="L777">			return genericError();</span>
<span class="fc" id="L778">		}</span>
<span class="fc bfc" id="L779" title="All 2 branches covered.">		if (decision == 1) {</span>
<span class="fc" id="L780">			String empl = userRepository.findEmailById(r.getEmployee());</span>
<span class="fc" id="L781">			String msgbody = &quot;Hello!\nUser &quot; + uid + &quot; has accepted&quot;</span>
				+ &quot; your request for job &quot; + jid + &quot;: &quot;
<span class="fc" id="L783">				+ j.getJobtitle() + &quot;\n\nCongrats!\n\nLove,\n&quot;</span>
				+ &quot;Quickbucks&quot;;
			/*send an email to the user who has been accepted.*/
			try {
<span class="fc" id="L787">				sendEmailToUser(empl,</span>
					&quot;Quickbucks: Your Job Request&quot;,
					msgbody);
<span class="nc" id="L790">			} catch (MailException exception) {</span>
<span class="nc" id="L791">				exception.printStackTrace();</span>
<span class="fc" id="L792">			}</span>
			/*then formally reject everyone else*/
<span class="fc" id="L794">			requestRepository.blanketReject(jid, id);</span>
		}

<span class="fc" id="L797">		List&lt;Request&gt; notifs = requestRepository.getNotifsByUserID(uid);</span>
<span class="fc" id="L798">		model.addAttribute(&quot;notifs&quot;, notifs);</span>
<span class="fc" id="L799">		model.addAttribute(&quot;userr&quot;, uid);</span>
<span class="fc" id="L800">		return &quot;notifs&quot;;</span>
	}

	public String genericError() {
<span class="fc" id="L804">		return &quot;redirect:/generic-error.html&quot;;</span>
	}

	@RequestMapping(value = &quot;/profile&quot;, method = RequestMethod.GET)
   	public String viewUser(ModelMap model, @RequestParam String id)
	{
<span class="fc" id="L810">	 	User u = userRepository.findByID(id);</span>
<span class="fc bfc" id="L811" title="All 2 branches covered.">	 	if(u == null){</span>
<span class="fc" id="L812">			model.addAttribute(&quot;jobID&quot;, id);</span>
<span class="fc" id="L813">			return &quot;viewJobError&quot;;</span>
	 	}
	 	else{
<span class="fc" id="L816">			List reviews = new ArrayList();</span>
<span class="fc" id="L817">			reviews = reviewRepository.getUserReviews(u.getId());</span>
			//System.out.println(reviews.size());
			//System.out.println(u.getId());
<span class="fc" id="L820">			model.addAttribute(&quot;userID&quot;, u.getId());</span>
<span class="fc" id="L821">			model.addAttribute(&quot;name&quot;, u.getUserFirstName()+&quot; &quot; +u.getUserLastName());</span>
<span class="fc" id="L822">			model.addAttribute(&quot;school&quot;, u.getUserSchool());</span>
<span class="fc" id="L823">			model.addAttribute(&quot;degree&quot;, u.getUserDegree());</span>
<span class="fc" id="L824">			model.addAttribute(&quot;location&quot;, u.getUserLocation());</span>
<span class="fc" id="L825">			model.addAttribute(&quot;reviews&quot;, reviews);</span>
	   	}
		//model.addAttribute(&quot;title&quot;, j.getJobTitle());

<span class="fc" id="L829">		return &quot;viewUser&quot;;</span>
	}

	@RequestMapping(value = &quot;/myprofile&quot;, method = RequestMethod.GET)
   	public String viewUser(ModelMap model)
	{
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L836">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
		int uid;
		try {
<span class="fc" id="L839">			uid = userRepository.findIDByEmail(user.getUsername());</span>
<span class="fc" id="L840">		} catch (NullPointerException npe) {</span>
<span class="fc" id="L841">			model.addAttribute(&quot;jobID&quot;, &quot;-1&quot;);</span>
<span class="fc" id="L842">			return &quot;viewJobError&quot;;</span>
<span class="fc" id="L843">		}</span>
<span class="fc" id="L844">	 	User u = userRepository.findByID(uid+&quot;&quot;);</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">	 	if(u == null){</span>
<span class="nc" id="L846">			String hello = &quot;&quot; + uid + &quot;&quot;;</span>
<span class="nc" id="L847">			model.addAttribute(&quot;jobID&quot;, hello);</span>
<span class="nc" id="L848">			return &quot;viewJobError&quot;;</span>
	 	}
	 	else{
<span class="fc" id="L851">			List reviews = new ArrayList();</span>
<span class="fc" id="L852">			reviews = reviewRepository.getUserReviews(u.getId());</span>
<span class="fc" id="L853">			System.out.println(reviews.size());</span>
<span class="fc" id="L854">			System.out.println(u.getId());</span>
<span class="fc" id="L855">			model.addAttribute(&quot;userID&quot;, u.getId());</span>
<span class="fc" id="L856">			model.addAttribute(&quot;name&quot;, u.getUserFirstName()+&quot; &quot; +u.getUserLastName());</span>
<span class="fc" id="L857">			model.addAttribute(&quot;school&quot;, u.getUserSchool());</span>
<span class="fc" id="L858">			model.addAttribute(&quot;degree&quot;, u.getUserDegree());</span>
<span class="fc" id="L859">			model.addAttribute(&quot;location&quot;, u.getUserLocation());</span>
<span class="fc" id="L860">			model.addAttribute(&quot;reviews&quot;, reviews);</span>
	   	}
		//model.addAttribute(&quot;title&quot;, j.getJobTitle());

<span class="fc" id="L864">		return &quot;viewUser&quot;;</span>
	}

	@GetMapping(path=&quot;/demo/employeeReview&quot;)
	public String employeeReviewList(ModelMap model)
	{
		//System.out.println(&quot;herhehreherherh&quot;);
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L872">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L873">		int uid = userRepository.findIDByEmail(user.getUsername());</span>

<span class="fc" id="L875">		List&lt;Request&gt; requests = requestRepository.findRequestsByEmployer(&quot;&quot;+uid);</span>
<span class="fc" id="L876">		System.out.println(requests.size());</span>
<span class="fc bfc" id="L877" title="All 2 branches covered.">		for(int i = 0; i&lt; requests.size(); i++){</span>
			//check if review exists
<span class="fc" id="L879">			Request temp = requests.get(i);</span>
<span class="fc" id="L880">			Integer jobID = temp.getJob();</span>

			Review test;
			try {
<span class="fc" id="L884">				test = reviewRepository.lookupReviewByJobAndAuthor(jobID, uid);</span>
<span class="nc" id="L885">			} catch (Exception e) {</span>
				//multiple matches
<span class="nc" id="L887">				test = new Review();</span>
<span class="fc" id="L888">			}</span>
			//jobID.toString());
			//if it does, remove from list
<span class="fc bfc" id="L891" title="All 2 branches covered.">			if(test != null)</span>
<span class="fc" id="L892">				requests.remove(i);</span>

		}

<span class="fc" id="L896">		model.addAttribute(&quot;type&quot;, &quot;Employees&quot;);</span>
<span class="fc" id="L897">		model.addAttribute(&quot;results&quot;, requests);</span>
<span class="fc" id="L898">		return &quot;awaitingReview&quot;;</span>
	}

	@GetMapping(path=&quot;/demo/openjobs&quot;)
	public String employerJobs(ModelMap model)
	{
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L905">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L906">		int uid = userRepository.findIDByEmail(user.getUsername());</span>

<span class="fc" id="L908">		List&lt;JobDecision&gt; openJobs = new ArrayList&lt;JobDecision&gt;();</span>
<span class="fc" id="L909">		List&lt;Integer&gt; searchedJobs = new ArrayList&lt;Integer&gt;();</span>
<span class="fc" id="L910">		List&lt;Request&gt; requests = requestRepository.findRequestsByEmployer(&quot;&quot;+uid);</span>

<span class="fc bfc" id="L912" title="All 2 branches covered.">		for(int i = 0; i&lt; requests.size(); i++){</span>
			//include if decision not made
<span class="fc" id="L914">			Request temp = requests.get(i);</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">			if(searchedJobs.contains(temp.getJob()))</span>
<span class="nc" id="L916">				continue;</span>

<span class="pc bpc" id="L918" title="1 of 2 branches missed.">			if(temp.getDecision() == 0)</span>
<span class="nc" id="L919">				openJobs.add(new JobDecision(temp.getJob(), 0, temp.getTitle()));</span>
			else{
				Review test;
				try {
<span class="fc" id="L923">					test = reviewRepository.lookupReviewByJobAndAuthor(temp.getJob(), uid);</span>
<span class="fc" id="L924">				} catch (Exception e) {</span>
					//multiple matches
<span class="fc" id="L926">					test = new Review();</span>
<span class="fc" id="L927">				}</span>
<span class="fc bfc" id="L928" title="All 2 branches covered.">				if(test == null)</span>
<span class="fc" id="L929">					openJobs.add(new JobDecision(temp.getJob(), 1, temp.getTitle()));</span>
			}
<span class="fc" id="L931">			searchedJobs.add(temp.getJob());</span>
		}

<span class="fc" id="L934">		List&lt;Job&gt; allJobs = new ArrayList&lt;Job&gt;();</span>
<span class="fc" id="L935">		allJobs = jobRepository.findAllUsersJobs(uid);</span>
<span class="fc bfc" id="L936" title="All 2 branches covered.">		for(int i = 0; i&lt; allJobs.size(); i++){</span>
<span class="fc" id="L937">			Job temp = allJobs.get(i);</span>
<span class="fc bfc" id="L938" title="All 2 branches covered.">			if(searchedJobs.contains(temp.getId())){</span>
<span class="fc" id="L939">				continue;</span>
			}
			else{
<span class="fc" id="L942">				openJobs.add(new JobDecision(temp.getId(), 0, temp.getJobtitle()));</span>
			}
		}

<span class="fc" id="L946">		model.addAttribute(&quot;jobs&quot;, openJobs);</span>
<span class="fc" id="L947">		return &quot;openjobs&quot;;</span>
	}

	@RequestMapping(value = &quot;/cancelJob&quot;, method = RequestMethod.GET)
   	public String cancelJob(ModelMap model, @RequestParam String id)
	{
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L954">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L955">		int uid = userRepository.findIDByEmail(user.getUsername());</span>
		Job temp;
		try {
<span class="fc" id="L958">			temp = jobRepository.findJobByID(id);</span>
<span class="nc" id="L959">		} catch(Exception ee) {</span>
<span class="nc" id="L960">			System.out.println(&quot;LOOKUP&quot;+id);</span>
<span class="nc" id="L961">			return genericError();</span>

<span class="fc" id="L963">		}</span>
<span class="fc bfc" id="L964" title="All 2 branches covered.">		if(temp == null){</span>
<span class="fc" id="L965">			System.out.println(&quot;NULL&quot;+id);</span>
<span class="fc" id="L966">			return genericError();</span>

		}

		else{
<span class="pc bpc" id="L971" title="1 of 2 branches missed.">			if(temp.getUser() != uid)</span>
<span class="nc" id="L972">				model.addAttribute(&quot;msg&quot;, &quot;Error: cannot delete someone else's job&quot;);</span>
			else{


				try{
<span class="fc" id="L977">					jobRepository.delete(temp);</span>
<span class="fc" id="L978">					List&lt;Request&gt; requests2 = requestRepository.findRequestsByJob(id);</span>
<span class="pc bpc" id="L979" title="1 of 2 branches missed.">					for(int i = 0; i&lt;requests2.size(); i++){</span>
<span class="nc" id="L980">						requestRepository.delete(requests2.get(i));</span>
					}
<span class="nc" id="L982">				} catch(Exception ee) {</span>
<span class="nc" id="L983">				System.out.println(&quot;DELETE&quot;+id);</span>
<span class="nc" id="L984">				return genericError();</span>
<span class="fc" id="L985">				}</span>
<span class="fc" id="L986">				model.addAttribute(&quot;msg&quot;, &quot;Job successfully deleted.&quot;);</span>
			}
		}

<span class="fc" id="L990">		return &quot;cancel&quot;;</span>

	}

		@GetMapping(path=&quot;/demo/employerReview&quot;)
	public String employerReviewList(ModelMap model)
	{

		org.springframework.security.core.userdetails.User user
<span class="fc" id="L999">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L1000">		int uid = userRepository.findIDByEmail(user.getUsername());</span>

<span class="fc" id="L1002">		List&lt;Request&gt; requests = requestRepository.findRequestsByEmployee(&quot;&quot;+uid);</span>
<span class="fc" id="L1003">		System.out.println(requests.size());</span>
<span class="pc bpc" id="L1004" title="1 of 2 branches missed.">		for(int i = 0; i&lt; requests.size(); i++){</span>
			//check if review exists
<span class="nc" id="L1006">			Request temp = requests.get(i);</span>
<span class="nc" id="L1007">			Integer jobID = temp.getJob();</span>

			Review test;
			try {
<span class="nc" id="L1011">				test = reviewRepository.lookupReviewByJobAndAuthor(jobID, uid);</span>
<span class="nc" id="L1012">			} catch (Exception e) {</span>
				//multiple matches
<span class="nc" id="L1014">				test = new Review();</span>
<span class="nc" id="L1015">			}</span>

			//jobID.toString());
			//if it does, remove from list
<span class="nc bnc" id="L1019" title="All 2 branches missed.">			if(test != null)</span>
<span class="nc" id="L1020">				requests.remove(i);</span>

		}

<span class="fc" id="L1024">		model.addAttribute(&quot;type&quot;, &quot;Employeers&quot;);</span>
<span class="fc" id="L1025">		model.addAttribute(&quot;results&quot;, requests);</span>
<span class="fc" id="L1026">		return &quot;awaitingReview&quot;;</span>
	}


		@GetMapping(path=&quot;/demo/upcoming&quot;)
	public String employeeAccepted(ModelMap model)
	{
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L1034">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L1035">		int uid = userRepository.findIDByEmail(user.getUsername());</span>



<span class="fc" id="L1039">		List&lt;Request&gt; requests = requestRepository.findRequestsByEmployee(&quot;&quot;+uid);</span>
<span class="pc bpc" id="L1040" title="1 of 2 branches missed.">			for(int i = 0; i&lt;requests.size(); i++){</span>
<span class="nc" id="L1041">				Request temp = requests.get(i);</span>
<span class="nc" id="L1042">				Integer jobID = temp.getJob();</span>

					Review test;
					try {
<span class="nc" id="L1046">						test = reviewRepository.lookupReviewByJobAndAuthor(jobID, uid);</span>
<span class="nc" id="L1047">					} catch (Exception e) {</span>
						//multiple matches
<span class="nc" id="L1049">						test = new Review();</span>
<span class="nc" id="L1050">					}</span>

<span class="nc bnc" id="L1052" title="All 2 branches missed.">					if(test != null)</span>
<span class="nc" id="L1053">						requests.remove(i);</span>
			}



<span class="fc" id="L1058">		model.addAttribute(&quot;title&quot;, &quot;Hired Jobs&quot;);</span>
<span class="fc" id="L1059">		model.addAttribute(&quot;jobs&quot;, requests);</span>
<span class="fc" id="L1060">		return &quot;employeeJobs&quot;;</span>
	}

			@GetMapping(path=&quot;/demo/pending&quot;)
	public String employeePending(ModelMap model)
	{
		org.springframework.security.core.userdetails.User user
<span class="fc" id="L1067">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="fc" id="L1068">		int uid = userRepository.findIDByEmail(user.getUsername());</span>



<span class="fc" id="L1072">		List&lt;Request&gt; requests = requestRepository.findRequestsByEmployeeUndecided(&quot;&quot;+uid);</span>


<span class="fc" id="L1075">		model.addAttribute(&quot;title&quot;, &quot;Pending Requests&quot;);</span>
<span class="fc" id="L1076">		model.addAttribute(&quot;jobs&quot;, requests);</span>
<span class="fc" id="L1077">		return &quot;employeeJobs&quot;;</span>
	}

	@RequestMapping(value = &quot;/cancelReq&quot;, method = RequestMethod.GET)
   	public String cancelReq(ModelMap model, @RequestParam String id)
	{
		org.springframework.security.core.userdetails.User user
<span class="nc" id="L1084">			= (org.springframework.security.core.userdetails.User)SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
<span class="nc" id="L1085">		int uid = userRepository.findIDByEmail(user.getUsername());</span>
		Request temp;
		try {
<span class="nc" id="L1088">			temp = requestRepository.findRequestByIDString(id);</span>
<span class="nc" id="L1089">		} catch(Exception ee) {</span>
<span class="nc" id="L1090">			System.out.println(&quot;LOOKUP&quot;+id);</span>
<span class="nc" id="L1091">			return genericError();</span>
<span class="nc" id="L1092">		}</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">		if(temp == null)</span>
<span class="nc" id="L1094">			return genericError();</span>

<span class="nc bnc" id="L1096" title="All 2 branches missed.">		if(temp.getEmployee()!= uid)</span>
<span class="nc" id="L1097">			model.addAttribute(&quot;msg&quot;, &quot;Error: cannot delete someone else's request&quot;);</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">		else if(temp.getDecision() == 1){</span>
<span class="nc" id="L1099">			Integer jobID = temp.getJob();</span>
			Review test;
			try {
<span class="nc" id="L1102">				test = reviewRepository.lookupReviewByJobID(jobID);</span>
<span class="nc" id="L1103">			} catch (Exception e) {</span>
				//multiple matches
<span class="nc" id="L1105">				test = new Review();</span>
<span class="nc" id="L1106">			}</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">			if(test != null)</span>
<span class="nc" id="L1108">				model.addAttribute(&quot;msg&quot;, &quot;Error: cannot delete request for a completed job!&quot;);</span>
			else{
				try{
<span class="nc" id="L1111">				requestRepository.delete(temp);</span>
<span class="nc" id="L1112">				} catch(Exception ee) {</span>
<span class="nc" id="L1113">				return genericError();</span>
<span class="nc" id="L1114">				}</span>
<span class="nc" id="L1115">				model.addAttribute(&quot;msg&quot;, &quot;Request successfully deleted.&quot;);</span>
			}
<span class="nc" id="L1117">		}</span>
		else{
			try{
<span class="nc" id="L1120">				requestRepository.delete(temp);</span>
<span class="nc" id="L1121">			} catch(Exception ee) {</span>
<span class="nc" id="L1122">			return genericError();</span>
<span class="nc" id="L1123">			}</span>
<span class="nc" id="L1124">			model.addAttribute(&quot;msg&quot;, &quot;Request successfully deleted.&quot;);</span>
		}
<span class="nc" id="L1126">		return &quot;cancel&quot;;</span>

	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>